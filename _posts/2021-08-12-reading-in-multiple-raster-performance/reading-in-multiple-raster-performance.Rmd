---
title: "Reading in multiple raster performance."
description: |
  Comparing the performance of different methods to read in multiple raster files.
draft: true
author:
  - name: Thomas Zwagerman
    url: https://twitter.com/thomzwa
date: 08-12-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

This is a short blog post where I test the performance of different methods to read in multiple rasters.

# Efficiency

I've recently been working on a project where lots of rasters would need to be processed, put together into a dataframe and then combined with other spatial data. That combined dataset would then need to be processed and written out again. 

In other words, a pretty long workflow - which can be quite prone to error. Having to do re-runs of such a lengthy process is not only annoying but also extremely time consuming.

For that reason I thought I'd test some different ways of processing rasters, so that at least the upfront processing time for each re-run is minimised.

Let's get started with the method I used in my project, and then we'll try some improvements from there!

# A look at the files to process

I can't share the rasters I used for my project, so instead I'm working with a small dataset from the FAO, called [Gridded Livestock of the World](http://www.fao.org/livestock-systems/global-distributions/en/). Pretty much what it says on the tin, with different rasters for each animal type. It's a good dataset for this purpose as it's relatively lightweight and I already now all rasters are the same extent.

```{r directory_numbers, warning = FALSE, echo = FALSE, message=FALSE}
#Libraries----
library(tidyverse)
library(raster)
library(sf)
library(microbenchmark)
library(stars)
library(ggplot2)
library(knitr)
library(terra)

lu_dir <- "C:/Users/thowag/Documents/tz_web_distill/_posts/2021-08-12-reading-in-multiple-raster-performance/glw_rasters/"
#lu_dir <- "/glw_rasters/"
l_files <- list.files(lu_dir, pattern = ".tif")
l_files <- paste0(lu_dir,l_files)
```

Now let's have a look at the different methods of reading in multiply raster files.

# The methods
The first method is the one I used during my project, which is stack(). The reason I went for stack() is that it's probably the most concise method of stacking a large number of rasters, because you read the raster files straight into a stack. But... I had a feeling this was maybe taking more time than I'd like.

```{r stack_method, warning = FALSE, echo = FALSE, message=FALSE, echo = TRUE, results=FALSE}
stack(l_files)
```

A method I was curious about after reading [Chapter 3 of Efficient R programming](https://csgillespie.github.io/efficientR/programming.html#the-apply-family) by Colin Gillespie and Robin Lovelace, is whether maybe using lapply to individually reading in rasters into a list, and then stacking them is faster than reading in the rasters into a stack straight away.

Of course, that is multiple functions, so to make it work within microbenchmark, I'm defining it into a single function here. Normally I probably wouldn't bother doing that.

```{r lapply_method, warning = FALSE, message=FALSE, echo = TRUE, results=FALSE}
func_apply_n_raster <- function(files_to_read){
#reading the rasters in individually, into a list object
l_rasters <- lapply(files_to_read, raster)
#then stack the read in list object into a single stack
s_rasters <- stack(l_rasters)
return(s_rasters)
}
```

Another package I've been curious about for a while, but haven't found an excuse to use yet, is [stars](https://r-spatial.github.io/stars/). Now I have no idea how this works in the background, so I have no idea if this will be faster, but that's the fun of the experiment.

```{r stars_method, warning = FALSE, message=FALSE, echo = TRUE, results=FALSE}
read_stars(l_files)
```

Another new package is [terra](https://github.com/rspatial/terra) which is inteded to replace raster. Unlike raster, the rast() function in terra already reads in multiple rasters, so there's no need to write a function in combination with lapply() as we did for raster().

```{r terra_method, warning = FALSE, message=FALSE, echo = TRUE, results=FALSE}
rast(l_files)
```


# Running the benchmark
Now I've given a sample of the 4 methods, let's run the benchmark and see which is fastest.

```{r benchmark, warning = FALSE, message=FALSE}
res <- microbenchmark(
  stack = stack(l_files[1:3]),
  lapply_and_raster = func_apply_n_raster(l_files[1:3]),
  read_stars = read_stars(l_files[1:3]),
  terra_rast = rast(l_files[1:3]),
  times = 100
)
#the reason I'm passing a summary() function through to kable is that
#kable (or any paged table function) doesn't provide expected output with a microbenchmark output
#see this open issue https://github.com/rstudio/rmarkdown/issues/1469
kable(summary(res))
```

The method I used throughout my project's lifetime, stack(), has not come out too well in this test. From the stars package, read_stars() is the slowest method, but perhaps reading in multiple rasters wasn't the function it was optimised for specifically. The lapply + raster method is a wee bit faster than stack(), as I suspected, but terra's rast() knocks both of these out of the park! I think this means it is time for me properly look into terra and start replacing raster in my workflow.

Let's plot it as well just to see some of the range here:

```{r benchmark_plot, warning = FALSE}
autoplot(res)

```

So lapply(x, raster) and stack() are definitely faster than read_stars() on average. While stack() is a wee bit slower than lapply(x, raster), they do mostly overlap. In this case I think it seems to be a tradeoff between more concise code (stack()) or a slightly faster processing time, but the difference is minimal.

Terra's rast() however, has both. It's far more concise and much faster. Another benefit seems to be that there is no differentiation between stack() and raster(), so whether reading in a large folder of rasters or reading in a single raster the user doesn't have to use a different function.

