---
title: "Reading in multiple raster performance."
description: |
  Comparing the performance of different methods to read in multiple raster files.
draft: true
author:
  - name: Thomas Zwagerman
    url: https://twitter.com/thomzwa
date: 08-12-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

This is a short blog post where I test the performance of different methods to read in multiple rasters.

# Efficiency

I've recently been working on a project where lots of rasters would need to be processed, put together into a dataframe and then combined with other spatial data. That combined dataset would then need to be processed and written out again. 

In other words, a pretty long workflow - which can be quite prone to error. Having to do re-runs of such a lengthy process is not only annoying but also extremely time consuming.

For that reason I thought I'd test some different ways of processing rasters, so that at least the upfront processing time for each re-run is minimised.

Let's get started with the method I used in my project, and then we'll try some improvements from there!

# A look at the files to process

```{r directory_numbers, warning = FALSE, echo = FALSE, message=FALSE}
#Libraries----
library(tidyverse)
library(raster)
library(sf)
library(microbenchmark)
library(stars)
library(ggplot2)
library(knitr)

lu_dir <- "//nerclactdb.adceh.ceh.ac.uk/Projects/PROJECTS1/SPEED_Metal/Atmos_inputs/Land_Use/BELUC_outputs/run8/output_agg_1km/"
length(list.files(lu_dir))
l_files <- list.files(lu_dir, pattern = ".tif")
l_files <- paste0(lu_dir,l_files)
```

A pretty chunky folder - let's have a look at the different methods of reading in multiply raster files.

# The methods

```{r stack_method, warning = FALSE, echo = FALSE, message=FALSE, echo = TRUE}
stack(l_files[1:3])
```

A method I was curious about after reading [Chapter 3 of Efficient R programming](https://csgillespie.github.io/efficientR/programming.html#the-apply-family) by Colin Gillespie and Robin Lovelace, is whether maybe using lapply to individually reading in rasters into a list, and then stacking them is faster than reading in the rasters into a stack straight away.

So let's try that method, which looks like this:

```{r lapply_method, warning = FALSE, message=FALSE, echo = TRUE}
lapply(l_files[1:3], raster)
```

Another package I've been curious about for a while, but haven't found an excuse to use yet, is [stars](https://r-spatial.github.io/stars/). Now I have no idea how this works in the background, so I have no idea if this will be faster, but that's the fun of the experiment.

```{r stars_method, warning = FALSE, message=FALSE, echo = TRUE}
read_stars(l_files[1:3])

```

# Running the benchmark
Now I've given a sample of the 3 methods, let's run the benchmark and see which is fastest.

```{r benchmark, warning = FALSE, message=FALSE}
res <- microbenchmark(
  stack_method = stack(l_files[1:3]),
  lapply_method = lapply(l_files[1:3], raster),
  stars_method = read_stars(l_files[1:3]),
  times = 10
)
kable(res)
```

Of course, the method I used throughout my project's lifetime, stack(), is the slowest. The lapply method is a wee bit faster, but read_stars is on average almost twice as fast! I think this means it is time for me properly look into stars and incorporate it into my workflow.

Let's plot it as well just to see some of the range here:

```{r benchmark_plot, warning = FALSE}
autoplot(res)

```

So lapply(x, raster) and read_stars() are definitely faster than stack() on average, but read_stars() and lapply(x, raster) do overlap a wee bit, so I could probably get away with using lapply until I learn to use stars properly... or is that another excuse I don't need to put off learning stars?

